<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/mesh.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/camera.js~CameraCommand.html">CameraCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/frame.js~FrameCommand.html">FrameCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry_buffer.js~GeometryBufferComand.html">GeometryBufferComand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/material.js~MaterialCommand.html">MaterialCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mesh.js~MeshCommand.html">MeshCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/object3d.js~Object3DCommand.html">Object3DCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/stats.js~Stat.html">Stat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/texture.js~TextureCommand.html">TextureCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createStatList">createStatList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decrementStat">decrementStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-headStat">headStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-incrementStat">incrementStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-registerStat">registerStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetStat">resetStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tailStat">tailStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_FAR">DEFAULT_CAMERA_FAR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_FIELD_OF_VIEW">DEFAULT_CAMERA_FIELD_OF_VIEW</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_NEAR">DEFAULT_CAMERA_NEAR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_ORIENTATION_ORIGIN">DEFAULT_CAMERA_ORIENTATION_ORIGIN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaults">defaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-stats">stats</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-clampToMaxSize">clampToMaxSize</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-createCanvas">createCanvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-debug">debug</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-define">define</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-getScreenOrientation">getScreenOrientation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-isDOMElementInViewport">isDOMElementInViewport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-lerp">lerp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-makePowerOfTwo">makePowerOfTwo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-nearestPowerOfTwo">nearestPowerOfTwo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-radians">radians</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-scaleWithCanvas">scaleWithCanvas</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">geometry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/box.js~BoxGeometry.html">BoxGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/geometry.js~Geometry.html">Geometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/plane.js~PlaneGeometry.html">PlaneGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/sphere.js~SphereGeometry.html">SphereGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/triangle.js~TriangleGeometry.html">TriangleGeometry</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">input</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/keyboard.js~KeyboardInputCommand.html">KeyboardInputCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/mouse.js~MouseInputCommand.html">MouseInputCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/orientation.js~OrientationInputCommand.html">OrientationInputCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/touch.js~TouchInputCommand.html">TouchInputCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">math</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/euler.js~Euler.html">Euler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/quaternion.js~Quaternion.html">Quaternion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/vector.js~Vector.html">Vector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-computeQuaternion">computeQuaternion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-computeEuler">computeEuler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-XVector3">XVector3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-YVector3">YVector3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ZVector3">ZVector3</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/mesh.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

/**
 * Module dependencies.
 */

import { Object3DCommand } from &apos;./object3d&apos;
import { incrementStat } from &apos;./stats&apos;
import getBoundingBox from &apos;bound-points&apos;
import injectDefines from &apos;glsl-inject-defines&apos;
import { Geometry } from &apos;./geometry&apos;
import { define } from &apos;./utils&apos;
import coalesce from &apos;defined&apos;
import glslify from &apos;glslify&apos;
import clamp from &apos;clamp&apos;
import mat4 from &apos;gl-mat4&apos;
import vec4 from &apos;gl-vec4&apos;
import vec3 from &apos;gl-vec3&apos;
import vec2 from &apos;gl-vec2&apos;
import quat from &apos;gl-quat&apos;

import {
  Quaternion,
  Vector,
} from &apos;./math&apos;

const identity = mat4.identity([])

const kDefaultMeshComplexWireframePrimitive = &apos;triangles&apos;
const kDefaultMeshWireframePrimitive = &apos;line strip&apos;
const kDefaultWireframeThickness = 0.0125
const kDefaultMeshPrimitive = &apos;triangles&apos;
const kDefaultVertexShader = glslify(__dirname + &apos;/glsl/mesh/vert.glsl&apos;)

/**
 * MeshCommand constructor.
 * @see MeshCommand
 */

module.exports = exports = (...args) =&gt; new MeshCommand(...args)
export class MeshCommand extends Object3DCommand {
  constructor(ctx, initialState = {}) {
    incrementStat(&apos;Mesh&apos;)

    let {
      regl: reglOptions = {},
      vert: vertexShader = kDefaultVertexShader,

      attributes = {},
      primitive = &apos;triangles&apos;,
      geometry = null,
    } = initialState

    // computed bounding box that is computed once
    // and cached in this variable
    let boundingBox = null

    // draw function created by regl
    // if a geometry is given
    let draw = () =&gt; void 0

    // initial configurable state
    const initial = {
      wireframeThickness: (
        initialState.wireframeThickness
        || kDefaultWireframeThickness
      ),

      wireframe: Boolean(initialState.wireframe),
      count: initialState.count || undefined
    }

    // shader unifors
    const uniforms = {
      model: ({transform}) =&gt; transform || identity,

      wireframeThickness: ({}, {
        wireframeThickness = initial.wireframeThickness
      } = {}) =&gt; {
        return wireframeThickness
      },

      wireframe: ({}, {
        wireframe = initial.wireframe
      } = {}) =&gt; {
        return Boolean(wireframe)
      },

    }

    // regl context
    const context = {
      ...reglOptions.context,

      get boundingBox() { return () =&gt; computeBoundingBox() },
      get geometry() { return geometry || null },
      get size() { return () =&gt; computeSize() },
    }

    Object.assign(reglOptions, {context})

    // configure vertex shader if a geometry with a
    // simpicial complex is given
    if (geometry) {
      if (!(geometry instanceof Geometry)) {
        // coerce to usable geometry
        geometry = new Geometry({complex: geometry})
      }

      Object.assign(reglOptions, {
        attributes,
        uniforms,
      })

      // shader defines injected into vertex shader
      const shaderDefines = {}

      // helper function to set attribute that dynamically
      // selects wireframe complex or mesh complex
      const attr = (name, macro, fallback = () =&gt; void 0) =&gt; {
        const pl = n =&gt; `${n}s`
        const w = geometry.wireframe
        const p = geometry.complex
        if (p[pl(name)] || w[pl(name)]) {
          shaderDefines[macro] = &apos;&apos;
          attributes[name] = ({}, args = {}) =&gt; {
            const {wireframe = initial.wireframe} = args
            if (wireframe) {
              return (w[pl(name)] || fallback(args) || p[pl(name)] || null)
            } else {
              return (p[pl(name)] || fallback(args) || w[pl(name)] || null)
            }
          }
        }
      }

      // vertex attributes defined with macro #ifdef ... #endif
      // wrapper
      attr(&apos;nextPosition&apos;, &apos;HAS_NEXT_POSITIONS&apos;)
      attr(&apos;direction&apos;, &apos;HAS_DIRECTIONS&apos;)
      attr(&apos;position&apos;, &apos;HAS_POSITIONS&apos;)
      attr(&apos;normal&apos;, &apos;HAS_NORMALS&apos;)
      attr(&apos;uv&apos;, &apos;HAS_UVS&apos;, ({wireframe = initial.wireframe} = {}) =&gt; {
        if (wireframe) {
          return geometry.wireframe.positions.map((p) =&gt; p.slice(0, 2))
        } else {
          return geometry.complex.positions.map((p) =&gt; p.slice(0, 2))
        }
      })

      Object.assign(reglOptions, {
        primitive: geometry &amp;&amp; (({}, {
          primitive: inputPrimitive = null,
          wireframe = false,
        } = {}) =&gt; {
          if (inputPrimitive) {
            return inputPrimitive
          } else if (wireframe) {
            if (geometry.wireframe) {
              return kDefaultMeshComplexWireframePrimitive
            } else {
              return kDefaultMeshWireframePrimitive
            }
          } else if (&apos;string&apos; == typeof primitive) {
            return primitive
          } else {
            return kDefaultMeshPrimitive
          }
        })
      })

      if (geometry.complex.cells) {
        Object.assign(reglOptions, {
          elements: ({}, {
            wireframe = initial.wireframe,
            count = initial.count,
          } = {}) =&gt; {
            let cells = null
            if (wireframe &amp;&amp; geometry.wireframe &amp;&amp; geometry.wireframe.cells) {
              cells = geometry.wireframe.cells
            } else if (geometry &amp;&amp; geometry.complex.cells) {
              cells = geometry.complex.cells
            }

            if (cells) {
              count = coalesce(count, cells.length)
              count = clamp(Math.floor(count), 0, cells.length)
              cells = cells.slice(0, count)
            }

            return cells
          }
        })
      } else {
        Object.assign(reglOptions, {
          count: ({}, {count} = {}) =&gt; {
            if (null != count) { return count }
            else if (initialState.count) { return initialState.count }
            else if (geometry &amp;&amp; geometry.complex) {
              return geometry.complex.positions.length
            } else {
              return null
            }
          }
        })
      }

      if (vertexShader) {
        reglOptions.vert = injectDefines(vertexShader, shaderDefines)
      }

      for (let key in reglOptions) {
        if (undefined === reglOptions[key]) {
          delete reglOptions[key]
        }
      }

      if (geometry) {
        draw = ctx.regl(reglOptions)
      }
    }

    super(ctx, {
      ...initialState,

      // Draws mesh and with given state and
      // then calling an optional given block
      draw(state = {}, block = () =&gt; void 0) {
        const noop = () =&gt; void 0

        if (&apos;function&apos; == typeof state) {
          block = state
          state = {}
        }

        state = state || {}
        block = block || noop

        // helper function to call hook defined on
        // input state falling back to initial state
        const hook = (name) =&gt;
          void (state[name] || initialState[name] || noop)({ ...state })

        if (null == ctx.reglContext) {
          block({ ...(ctx.reglContext || {}) })
        } else {
          if (false != state.draw) {
            hook(&apos;beforeDraw&apos;)
            draw(state)
            hook(&apos;afterDraw&apos;)
            block({ ...ctx.reglContext })
          } else {
            draw(state, () =&gt; { block({ ...ctx.reglContext }) })
          }
        }
      }
    })

    //
    // Function to compute the bounding box of the internal
    // geometry. The original simpicial complex is used, not
    // the wireframe complex. The bounding box is computed once
    // and cached.
    //
    function computeBoundingBox() {
      if (geometry &amp;&amp; null == boundingBox) {
        boundingBox = (
          getBoundingBox(geometry.positions)
          .map((p) =&gt; new Vector(...p))
        )
      }

      return boundingBox
    }

    //
    // Function to compute the size of the geometry with
    // respect to scaling and dimension
    //
    function computeSize() {
      if (null == geometry) {
        return null
      }

      computeBoundingBox()

      const dimension = boundingBox[0].length
      const {scale} = ctx.reglContext // scale is injected by `Object3DCommand`
      const min = boundingBox[0]
      const max = boundingBox[1]
      let size = null

      switch (dimension) {
        case 3: size = vec3.subtract(new Vector(0, 0, 0), max, min); break
        case 2: size = vec2.subtract(new Vector(0, 0), max, min); break
        default: return null
      }

      switch (dimension) {
        case 3: return vec3.multiply(size, size, scale)
        case 2: return vec2.multiply(size, size, scale)
      }
    }
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
