<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/mesh.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/camera.js~CameraCommand.html">CameraCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/command.js~Command.html">Command</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/context.js~Context.html">Context</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/frame.js~FrameCommand.html">FrameCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry_buffer.js~GeometryBufferComand.html">GeometryBufferComand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lines.js~LinesCommand.html">LinesCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mesh.js~MeshCommand.html">MeshCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/object3d.js~Object3DCommand.html">Object3DCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/stats.js~Stat.html">Stat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/texture.js~TextureCommand.html">TextureCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createStatList">createStatList</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decrementStat">decrementStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-headStat">headStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-incrementStat">incrementStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-registerStat">registerStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-resetStat">resetStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tailStat">tailStat</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clampToMaxSize">clampToMaxSize</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createCanvas">createCanvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-define">define</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-getScreenOrientation">getScreenOrientation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isDOMElementInViewport">isDOMElementInViewport</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lerp">lerp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-makePowerOfTwo">makePowerOfTwo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-nearestPowerOfTwo">nearestPowerOfTwo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-radians">radians</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-scaleWithCanvas">scaleWithCanvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_FAR">DEFAULT_CAMERA_FAR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_FIELD_OF_VIEW">DEFAULT_CAMERA_FIELD_OF_VIEW</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_NEAR">DEFAULT_CAMERA_NEAR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DEFAULT_CAMERA_ORIENTATION_ORIGIN">DEFAULT_CAMERA_ORIENTATION_ORIGIN</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-defaults">defaults</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-stats">stats</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-debug">debug</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">geometry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/box.js~BoxGeometry.html">BoxGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/capsule.js~CapsuleGeometry.html">CapsuleGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/cylinder.js~CylinderGeometry.html">CylinderGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/geometry.js~Geometry.html">Geometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/plane.js~PlaneGeometry.html">PlaneGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/sphere.js~SphereGeometry.html">SphereGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/torus.js~TorusGeometry.html">TorusGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/geometry/triangle.js~TriangleGeometry.html">TriangleGeometry</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">input</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/keyboard.js~KeyboardInputCommand.html">KeyboardInputCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/mouse.js~MouseInputCommand.html">MouseInputCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/orientation.js~OrientationInputCommand.html">OrientationInputCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/input/touch.js~TouchInputCommand.html">TouchInputCommand</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">light</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/light/ambient.js~AmbientLightCommand.html">AmbientLightCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/light/directional.js~DirectionalLightCommand.html">DirectionalLightCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/light/light.js~LightCommand.html">LightCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/light/point.js~PointLightCommand.html">PointLightCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-kMaxAmbientLights">kMaxAmbientLights</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-kMaxDirectionalLights">kMaxDirectionalLights</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-kMaxPointLights">kMaxPointLights</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-AmbientLight">AmbientLight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DirectionalLight">DirectionalLight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Light">Light</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PointLight">PointLight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-SpotLight">SpotLight</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">material</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/material/flat.js~FlatMaterialCommand.html">FlatMaterialCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/material/lambert.js~LambertMaterialCommand.html">LambertMaterialCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/material/material.js~MaterialCommand.html">MaterialCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/material/phong.js~PhongMaterialCommand.html">PhongMaterialCommand</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-FlatMaterial">FlatMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-LambertMaterial">LambertMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Material">Material</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-PhongMaterial">PhongMaterial</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">math</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/euler.js~Euler.html">Euler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/quaternion.js~Quaternion.html">Quaternion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/math/vector.js~Vector.html">Vector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-computeQuaternion">computeQuaternion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-computeEuler">computeEuler</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/mesh.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

/**
 * Module dependencies.
 */

import { Object3DCommand } from &apos;./object3d&apos;
import { incrementStat } from &apos;./stats&apos;
import getBoundingBox from &apos;bound-points&apos;
import injectDefines from &apos;glsl-inject-defines&apos;
import { Geometry } from &apos;./geometry&apos;
import { define } from &apos;./utils&apos;
import coalesce from &apos;defined&apos;
import glslify from &apos;glslify&apos;
import clamp from &apos;clamp&apos;
import mat4 from &apos;gl-mat4&apos;
import mat3 from &apos;gl-mat3&apos;
import vec4 from &apos;gl-vec4&apos;
import vec3 from &apos;gl-vec3&apos;
import vec2 from &apos;gl-vec2&apos;
import quat from &apos;gl-quat&apos;

import {
  Quaternion,
  Vector,
} from &apos;./math&apos;

const identity = mat4.identity([])

const kDefaultMeshWireframePrimitive = &apos;line strip&apos;
const kDefaultWireframeThickness = 1
const kDefaultMeshPrimitive = &apos;triangles&apos;
const kDefaultVertexShader = glslify(__dirname + &apos;/glsl/mesh/vert.glsl&apos;)

module.exports = exports = (...args) =&gt; new MeshCommand(...args)
export class MeshCommand extends Object3DCommand {
  constructor(ctx, initialState = {}) {
    incrementStat(&apos;Mesh&apos;)

    let {
      regl: reglOptions = {},
      vert: vertexShader = kDefaultVertexShader,
      frag: fragmentShader = null,

      primitive = &apos;triangles&apos;,
      geometry = null,
    } = initialState

    // computed bounding box that is computed once
    // and cached in this variable
    let boundingBox = null

    // draw function created by regl
    // if a geometry is given
    let draw = () =&gt; void 0

    // initial configurable state
    const initial = {
      wireframeThickness: (
        initialState.wireframeThickness
        || kDefaultWireframeThickness
      ),

      wireframe: Boolean(initialState.wireframe),
      count: initialState.count || undefined
    }

    const attributes = {}

    // shader uniforms
    const uniforms = {
      model: ({transform}) =&gt; transform || identity,
      modelNormal: ({transform}, {} = {}, id) =&gt; {
        return (
          transform ?
          mat3.normalFromMat4([], transform) :
          identity
        )
      },

      // at least enough for flat shading incase a material isn&apos;t given
      &apos;material.opacity&apos;: ({materialOpacity}, {opacity = materialOpacity} = {}) =&gt; opacity,
      &apos;material.color&apos;: ({materialColor}, {color = materialColor} = {}) =&gt; color,
    }

    // regl context
    const context = {
      ...reglOptions.context,

      boundingBox: computeBoundingBox,
      geometry: geometry || null,
      size: computeSize,
    }

    Object.assign(reglOptions, {context})

    // configure vertex shader if a geometry with a
    // simpicial complex is given
    if (geometry) {
      Object.assign(attributes, initialState.attributes)
      Object.assign(uniforms, initialState.uniforms)
      Object.assign(reglOptions, {
        attributes,
        uniforms,
      })

      // shader defines injected into vertex shader
      const shaderDefines = {
        ...initialState.shaderDefines
      }

      if (geometry.positions) {
        attributes.position = geometry.positions
        shaderDefines[&apos;HAS_POSITIONS&apos;] = 1
      }

      if (geometry.normals) {
        attributes.normal = geometry.normals
        shaderDefines[&apos;HAS_NORMALS&apos;] = 1
      }

      if (geometry.uvs) {
        attributes.uv = geometry.uvs
        shaderDefines[&apos;HAS_UVS&apos;] = 1
      }

      Object.assign(reglOptions, {
        primitive: geometry &amp;&amp; (({}, {
          primitive: inputPrimitive = null,
          wireframe = false,
        } = {}) =&gt; {
          if (inputPrimitive) {
            return inputPrimitive
          } else if (wireframe) {
            return kDefaultMeshWireframePrimitive
          } else if (&apos;string&apos; == typeof primitive) {
            return primitive
          } else {
            return kDefaultMeshPrimitive
          }
        })
      })

      if (geometry.cells) {
        Object.assign(reglOptions, {
          elements: ({}, {
            wireframe = initial.wireframe,
            count = initial.count,
          } = {}) =&gt; {
            let cells = geometry.cells
            if (cells &amp;&amp; &apos;number&apos; == typeof count) {
              count = coalesce(count, cells.length)
              count = clamp(Math.floor(count), 0, cells.length)
              cells = cells.slice(0, count)
            }
            return cells
          }
        })
      } else {
        Object.assign(reglOptions, {
          count: ({}, {count} = {}) =&gt; {
            if (null != count) { return count }
            else if (initialState.count) { return initialState.count }
            else if (geometry &amp;&amp; geometry.complex) {
              return geometry.positions.length
            } else {
              return null
            }
          }
        })
      }

      if (&apos;string&apos; == typeof vertexShader) {
        reglOptions.vert = injectDefines(vertexShader, shaderDefines)
      }

      if (&apos;string&apos; == typeof fragmentShader) {
        reglOptions.frag = injectDefines(fragmentShader, shaderDefines)
      }

      for (let key in reglOptions) {
        if (undefined === reglOptions[key]) {
          delete reglOptions[key]
        }
      }

      if (geometry) {
        draw = ctx.regl({
          lineWidth: ({}, {
            wireframeThickness = initial.wireframeThickness,
            lineWidth = 1,
          } = {}) =&gt; {
            return Math.max(wireframeThickness || lineWidth, 1)
          },
          ...reglOptions
        })
      }
    }

    super(ctx, {
      ...initialState,

      // Draws mesh and with given state and
      // then calling an optional given block
      update(state, block) {
        const noop = () =&gt; void 0

        if (&apos;function&apos; == typeof state) {
          block = state
          state = {}
        }

        state = state || {}
        block = block || noop

        // helper function to call hook defined on
        // input state falling back to initial state
        const hook = (name) =&gt;
          void (state[name] || initialState[name] || noop)(state)

        const update = initialState.update || (({} = {}, f) =&gt; f())

        update(state, () =&gt; {
          if (null == ctx.reglContext) {
            block({ ...(ctx.reglContext || {}) })
          } else {
            ctx.reglContext.geometry = geometry
            if (false === state.visible) {
              draw(state, block)
            } else if (false != state.draw) {
              hook(&apos;beforeDraw&apos;)
              draw(state)
              hook(&apos;afterDraw&apos;)
              block({ ...ctx.reglContext }, state)
            } else {
              draw(state, block)
            }
            delete ctx.reglContext.geometry
          }
        })
      }
    })

    //
    // Function to compute the bounding box of the internal
    // geometry. The bounding box is computed once and cached.
    //
    function computeBoundingBox({}, {} = {}) {
      return () =&gt; {
        if (geometry &amp;&amp; null == boundingBox) {
          boundingBox = (
            getBoundingBox(geometry.positions)
            .map((p) =&gt; new Vector(...p))
          )
        }

        return boundingBox
      }
    }

    //
    // Function to compute the size of the geometry with
    // respect to scaling and dimension
    //
    function computeSize({scale} = {}, {} = {}) {
      return () =&gt; {
        if (null == geometry) {
          return null
        }

        computeBoundingBox()

        const dimension = boundingBox[0].length
        const min = boundingBox[0]
        const max = boundingBox[1]
        let size = null

        switch (dimension) {
          case 3: size = vec3.subtract([], max, min); break
          case 2: size = vec2.subtract([], max, min); break
          default: return null
        }

        switch (dimension) {
          case 3: return vec3.multiply(size, size, scale)
          case 2: return vec2.multiply(size, size, scale)
        }
      }
    }
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
